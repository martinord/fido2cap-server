<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/index.es5.umd.min.js"></script>
    <script src="/ua-parser.pack.js"></script>
    <link rel="stylesheet" href="/almond.lite.min.css" />
    <link rel="stylesheet" href="/styles.css" />
    <title>Autenticaci√≥n con llave de seguridad</title>
  </head>
  <body>
    <div class="container">
      <div class="controls">
        <section id="userSection">
          <h2>¬°Hola! ¬øQuien eres?</h2>
          <div>
            <img src="img/people.webp" alt="Una persona sujetando una llave" width="200">
          </div>
          <div>
            <p>Introduce tu <strong>nombre de usuario</strong> y pulsa continuar</p>
          </div>
          <div id="user">
            <input id="username" type="text">
          </div>
          <div id="discoverable" style="margin: 2rem;">
            <input id="nonDiscoverable" type="checkbox">
            <label style="font-size: 1rem;">üëå&nbsp;No necesito un nombre de usuario</label>
          </div>
          <button id="btnUsername">
            üëâüèº&nbsp; Continuar
          </button>
          <p id="usernameError" class="error"></p>
        </section>
        <section id="authentication" hidden>
          <h2>Usa tu Llave de Seguridad</h2>
          <div>
            <img src="img/security-key.webp" alt="Una persona sujetando una llave" width="200">
          </div>
          <div>
            <p><strong id="errorTitle"></strong></p>
            <p id="errorDetail" class="error"></p>
          </div>
          <button id="btnAuthBegin" style="margin-top: 1rem;" hidden>
            üîÉ&nbsp;Probar de nuevo
          </button>
          <img id="authGif" class="loading" src="/loading.gif" alt="Autenticando..." width="200">
          <p id="authInfo"></p>
          <div id="information" class="information">
            <p>Usa tu <strong>Llave de Seguridad</strong> para entrar en un click.</p>
            <p><a href="/about">üîç&nbsp;Saber m√°s</a> <a href="/">‚¨ÖÔ∏è&nbsp;Volver atr√°s</a></p>
          </div>
        </section>
      </div>

      <p id="authSuccess" class="success"></p>

      <div id="imgError" hidden>
        <img src="img/error.png" alt="Persona confundida" width="200">
      </div>

      <p id="errorRedirect" class="error"></p>
      
      <button id="btnRedirectChrome" hidden="true" style="margin-top: 1rem; background-color: gray;">
        ‚ÜóÔ∏è&nbsp;Abrir en otro navegador
      </button>

      <button id="btnReload" hidden="true" style="margin-top: 1rem;" onclick="window.location.reload();">
        üîÉ&nbsp;Probar de nuevo
      </button>

    </div>
    <script>
      const { browserSupportsWebAuthn, startAuthentication } = SimpleWebAuthnBrowser;

      const elemButton = document.querySelector('#btnAuthBegin');
      const elemInfo = document.querySelector('#information');
      const elemSuccess = document.querySelector('#authSuccess');
      const elemAuthInfo = document.querySelector('#authInfo');
      const elemErrorDetail = document.querySelector('#errorDetail');
      const elemErrorRedirect = document.querySelector('#errorRedirect');
      const elemErrorTitle = document.querySelector('#errorTitle');
      const elemGif = document.querySelector('#authGif');
      const elemUsername = document.querySelector('#username');
      const elemUser = document.querySelector('#user');
      const elemDiscoverable = document.querySelector('#discoverable');
      const elemNonDiscoverable = document.querySelector('#nonDiscoverable');
      const elemUserSection = document.querySelector('#userSection');
      const elemAuthentication = document.querySelector('#authentication');
      const elemUsernameError = document.querySelector('#usernameError');
      const elemImgError = document.querySelector('#imgError');

      /**
       * Shows an error on the screen
       */
      function showError(title, message) {
        elemErrorTitle.innerHTML = title || "Operaci√≥n cancelada";
        elemErrorDetail.innerHTML = message;

        elemButton.hidden = false;

        elemGif.hidden = true;
        elemUserSection.hidden = true;
      }

      /**
       * Show redirection button when the browser is not compatible
       * 
       */
      function showRedirect() {

        // Redirect depending on the OS
        let os = new UAParser(window.navigator.userAgent).getOS().name;
        let redirection_url = '';

        if (os == "Android") {
          redirection_url = 'android-app://com.android.chrome/https/'+ window.location.href.split('://')[1];
        } else if (os == "iOS" || os == "macOS") {
          redirection_url = 'googlechrome://' + window.location.href.split('://')[1];
        } else {
          redirection_url = window.location.href;
        }

        // Message
        document.querySelector('.controls').style.display = 'none';
        document.querySelector('#imgError').hidden = false;
        elemErrorRedirect.innerHTML = "Puede que este navegador en " + os + " no soporte las Llaves de Seguridad. Copia la URL en otro navegador o prueba el siguiente bot√≥n. üëá";

        // Redirection button
        document.querySelector('#btnRedirectChrome').hidden = false;
        if(message) document.querySelector('#btnReload').hidden = false;
        document.querySelector('#btnRedirectChrome').addEventListener('click', async () => {
          window.open(redirection_url, '_blank');
        });
      }

      // Hide the Begin button if the browser is incapable of using WebAuthn
      if (!SimpleWebAuthnBrowser.browserSupportsWebAuthn()) showRedirect()
      else {

        /**
         * Get username
         */
        function getUsername() {
          if(elemUsername.value != '' || elemNonDiscoverable.checked) {
            elemUserSection.hidden = true;
            elemAuthentication.hidden = false;
            return true;
          } else {
            elemUsernameError.innerHTML = "Por favor, escribe tu nombre de usuario o marca la casilla."
            return false;
          }
        }

        document.querySelector('#btnUsername').addEventListener('click', authenticationCall);
        document.querySelector('#btnAuthBegin').addEventListener('click', authenticationCall);

        document.querySelector('#username').addEventListener('keydown', (event) => {
          if (event.keyCode === 13) authenticationCall(); // user presses enter
        });
        document.querySelector('#username').value = localStorage.getItem('username');

        /**
         * Display non-discoverable options
         */
        document.querySelector('#nonDiscoverable').addEventListener('click', async () => {
          elemUser.style = elemNonDiscoverable.checked? "display: none;" : "display: inline;";
        });

         /**
         * Authentication
         */
        async function authenticationCall () {

          // Check if username is valid
          if(!getUsername()) return;

          // Reset success/error messages
          elemSuccess.innerHTML = '';
          elemErrorTitle.innerHTML = '';
          elemErrorDetail.innerHTML = '';
          elemAuthInfo.innerHTML = '';
          elemGif.hidden = false;
          elemButton.hidden = true;

          const resp = await fetch('/api/authentication?' + new URLSearchParams({ 
            'username' : elemUsername.value.toLowerCase().trim(),
            'nonDiscoverable' : !elemNonDiscoverable.checked 
          }));

          localStorage.setItem('username', elemUsername.value.toLowerCase().trim());

          let asseResp;
          try {
            const opts = await resp.json();
            asseResp = await SimpleWebAuthnBrowser.startAuthentication(opts);
          } catch (error) {
            if (error.name == "InvalidStateError") {
              showError("Humm... Llave de Seguridad desconocida", "No conocemos esa Llave de Seguridad. ¬øEst√° registrada?");
            } else if (error.name == "NotAllowedError") {
              showError("¬°Vaya! No hemos encontrado tu Llave de Seguridad", "Se ha cancelado la operaci√≥n o puede que no se haya encontrado la Llave de Seguridad que has registrado. ¬°Prueba de nuevo o utiliza otra llave!");
            } else {
              showError("¬°Oh! Operaci√≥n cancelada", "Vaya... parece que algo no ha ido bien. ¬°Int√©ntalo de nuevo!");
            }
            throw new Error(error);
          }

          // Wait for verification response
          elemAuthInfo.innerHTML = 'Verificando tu identidad ...';
          elemButton.hidden = true;
          elemInfo.hidden = true;
          elemDiscoverable.hidden = true;
          elemUser.style = "display: none;";
          
          const verificationResp = await fetch('/api/authentication', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(asseResp),
          });

          // Show elements
          elemAuthInfo.innerHTML = '';
          elemGif.hidden = true;
          elemButton.hidden = false;
          elemInfo.hidden = false;
          elemDiscoverable.hidden = false;

          try {
            const verificationJSON = await verificationResp.json();

            if (verificationJSON && verificationJSON.verified) {
              elemSuccess.innerHTML = `¬°Usuario autenticado!`;
              window.location = '/user/';
            } else {
              showError("No hemos podido verificar tu identidad", "Puede que algo falle o que esta llave ya no est√© registrada. ¬°Aseg√∫rate de no mover la llave durante el proceso!");
            }
          } catch (error) {
            showError("No hemos podido verificar tu identidad", "Puede que algo falle o que esta llave ya no est√© registrada. ¬°Aseg√∫rate de no mover la llave durante el proceso!");
          }
          
        };
      }

    </script>
  </body>
</html>
